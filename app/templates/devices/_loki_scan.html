<!-- Filepath: app/templates/devices/_loki_scan.html -->
<!-- Loki Malware & IOC Scan Section -->
<!-- Show on Windows devices -->
{% if 'Windows' in device.hardwareinfo %}
<div class="row g-4 mt-4">
    <div class="col-12">
        <div class="card h-100 shadow">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                    <i class="fas fa-virus me-2"></i>
                    <h6 class="card-title mb-0">Malware & IOC Scan (Loki)</h6>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-warning text-dark">Preview</span>
                </div>
            </div>

            <div class="card-body">
                <!-- Loki Preview Alert -->
                <div class="alert alert-info mb-4" role="alert">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-rocket me-3 mt-1" style="font-size: 1.25rem;"></i>
                        <div>
                            <h5 class="alert-heading mb-2">Loki Malware Scanning (Preview)</h5>
                            <p class="mb-2">
                                Loki, a powerful IOC (Indicator of Compromise) and malware scanner, is being integrated
                                into Wegweiser. You can already trigger a safe test scan on this endpoint from here.
                            </p>
                            <p class="mb-0">
                                <strong>Note:</strong> This preview currently runs a safe test mode. Deeper scan profiles
                                and scheduling options will follow.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Loki Scheduler -->
                <form id="loki-scheduler-form" onsubmit="event.preventDefault(); scheduleLokiScanFromForm();">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Scan depth</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="loki_mode" id="loki_mode_test" value="test" checked>
                                <label class="form-check-label" for="loki_mode_test">
                                    Test scan (safe, limited scope)
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="loki_mode" id="loki_mode_quick" value="quick" disabled>
                                <label class="form-check-label text-muted" for="loki_mode_quick">
                                    Quick scan (system directories) &mdash; coming soon
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="loki_mode" id="loki_mode_full" value="full" disabled>
                                <label class="form-check-label text-muted" for="loki_mode_full">
                                    Full scan (all drives) &mdash; coming soon
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Execution</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="loki_schedule_type" id="loki_schedule_now" value="now" checked>
                                <label class="form-check-label" for="loki_schedule_now">
                                    Run now (one-time)
                                </label>
                            </div>
                            <div class="form-check d-flex align-items-center mt-1">
                                <input class="form-check-input" type="radio" name="loki_schedule_type" id="loki_schedule_time" value="time">
                                <label class="form-check-label ms-1" for="loki_schedule_time">
                                    Run once at
                                </label>
                                <input type="time" class="form-control form-control-sm ms-2" id="loki_start_time" name="loki_start_time">
                            </div>
                            <small class="text-muted d-block mt-1">
                                Time is interpreted in server timezone; the agent will execute on next check-in
                                after this time.
                            </small>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-play me-2"></i>Schedule Loki test scan
                        </button>
                    </div>
                </form>

                <!-- Placeholder Content -->
                {% if latest_loki_scan %}
                    {% if latest_loki_scan.processing_status == 'pending' %}
                        <!-- Processing State -->
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Processing...</span>
                            </div>
                            <p class="text-muted">Loki scan is being processed...</p>
                            <small class="text-muted">Results will appear shortly</small>
                        </div>
                    {% elif latest_loki_scan.processing_status == 'error' %}
                        <!-- Error State -->
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Error processing Loki scan</strong>
                            <p class="mb-0 mt-2">{{ latest_loki_scan.ai_analysis|safe }}</p>
                        </div>
                    {% elif latest_loki_scan.processing_status == 'processed' %}
                    <!-- Processed State - Show Results -->
                    <div class="row mb-4">
                        <!-- Security Score Gauge -->
                        <div class="col-md-3">
                            <div class="d-flex flex-column align-items-center">
                                <div class="loki-score-circle {% if latest_loki_scan.score >= 80 %}score-high{% elif latest_loki_scan.score >= 60 %}score-medium{% else %}score-low{% endif %}">
                                    <div class="score-inner">
                                        <span class="score-value">{{ latest_loki_scan.score }}</span>
                                        <span class="score-label">/100</span>
                                    </div>
                                </div>
                                <p class="text-center mt-2 mb-0">
                                    <strong>Security Score</strong>
                                </p>
                                <small class="text-muted">
                                    {% set loki_data = latest_loki_scan.metalogos %}
                                    {{ loki_data.summary.total_alerts if loki_data.summary else 0 }} alerts found
                                </small>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="col-md-9">
                            <div class="row g-3">
                                {% set loki_data = latest_loki_scan.metalogos %}
                                <div class="col-md-4">
                                    <div class="stat-card">
                                        <i class="fas fa-exclamation-circle text-danger"></i>
                                        <div>
                                            <h4>{{ loki_data.summary.total_alerts if loki_data.summary else 0 }}</h4>
                                            <p class="text-muted mb-0">Alerts</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        <div>
                                            <h4>{{ loki_data.summary.total_warnings if loki_data.summary else 0 }}</h4>
                                            <p class="text-muted mb-0">Warnings</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="stat-card">
                                        <i class="fas fa-info-circle text-info"></i>
                                        <div>
                                            <h4>{{ loki_data.summary.total_notices if loki_data.summary else 0 }}</h4>
                                            <p class="text-muted mb-0">Notices</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Truncation Notice -->
                            {% if loki_data.truncated %}
                            <div class="mt-3 p-3 rounded alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Large Result Set:</strong> Showing first 50 items per category.
                                {% if loki_data.total_original %}
                                Total: {{ loki_data.total_original.alerts }} alerts,
                                {{ loki_data.total_original.warnings }} warnings,
                                {{ loki_data.total_original.notices }} notices
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Detailed Report -->
                    <div class="loki-report-container mt-4">
                        <div class="loki-report">
                            {{ latest_loki_scan.ai_analysis|safe }}
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <!-- No Scan Data Yet - Placeholder -->
                    <div class="text-center py-5">
                        <i class="fas fa-search text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="text-muted mt-3 mb-2">No Loki scans have been run yet on this device</p>
                        <small class="text-muted d-block mb-4">Use the form above to schedule a safe Loki test scan.</small>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="scheduleLokiScanFromForm()">
                            <i class="fas fa-play me-2"></i>Run Loki test scan now
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<script>
async function scheduleLokiScanFromForm() {
    const form = document.getElementById('loki-scheduler-form');
    if (!form) {
        if (typeof showNotification === 'function') {
            showNotification('Loki scheduler form not found on page.', 'danger');
        }
        return;
    }

    const modeInput = form.querySelector('input[name="loki_mode"]:checked');
    const scheduleInput = form.querySelector('input[name="loki_schedule_type"]:checked');
    const mode = modeInput ? modeInput.value : 'test';
    const scheduleType = scheduleInput ? scheduleInput.value : 'now';
    const timeInput = document.getElementById('loki_start_time');
    const startTime = (scheduleType === 'time' && timeInput && timeInput.value) ? timeInput.value : '0';

    try {
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        const csrfToken = csrfMeta ? csrfMeta.getAttribute('content') : null;

        const headers = {
            'Content-Type': 'application/json'
        };
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch("{{ url_for('devices_bp.schedule_loki_scan', deviceuuid=device.deviceuuid) }}", {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                mode: mode,
                schedule_type: scheduleType,
                start_time: startTime
            })
        });

        const payload = await response.json().catch(() => ({}));
        if (response.ok && payload && payload.success) {
            if (typeof showNotification === 'function') {
                showNotification('Loki test scan scheduled. The agent will pick it up on next check-in.', 'success');
            }
        } else {
            const msg = payload && payload.error ? payload.error : 'Failed to schedule Loki scan.';
            if (typeof showNotification === 'function') {
                showNotification(msg, 'danger');
            }
        }
    } catch (err) {
        if (typeof showNotification === 'function') {
            showNotification('Error scheduling Loki scan: ' + err, 'danger');
        }
    }
}
</script>

<style>
.loki-score-circle {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    border: 3px solid;
    position: relative;
}

.loki-score-circle.score-high {
    background: rgba(40, 167, 69, 0.1);
    border-color: #28a745;
    color: #28a745;
}

.loki-score-circle.score-medium {
    background: rgba(255, 193, 7, 0.1);
    border-color: #ffc107;
    color: #ffc107;
}

.loki-score-circle.score-low {
    background: rgba(220, 53, 69, 0.1);
    border-color: #dc3545;
    color: #dc3545;
}

.loki-score-circle .score-inner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}

.loki-score-circle .score-value {
    font-size: 2.5rem;
    line-height: 1;
}

.loki-score-circle .score-label {
    font-size: 0.875rem;
    opacity: 0.8;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--glass-bg);
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
}

.stat-card i {
    font-size: 1.5rem;
}

.stat-card h4 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

.stat-card p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-muted);
}

.loki-report-container {
    margin-top: 2rem;
}

.loki-report {
    background: var(--glass-bg);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    padding: 1.5rem;
    border: 1px solid var(--border-color);
    border-radius: 0.375rem;
}

.loki-report h4,
.loki-report h5 {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
}

.loki-report h4:first-child,
.loki-report h5:first-child {
    margin-top: 0;
}

.loki-report ul,
.loki-report ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

.loki-report li {
    margin-bottom: 0.5rem;
}

.loki-report strong {
    color: var(--text-primary);
}

.loki-report em {
    font-style: italic;
    color: var(--text-secondary);
}
</style>
{% endif %}

