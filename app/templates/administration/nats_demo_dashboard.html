{% extends "base.html" %}

{% block title %}TEST NATS Streaming Demo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-satellite-dish"></i>TEST  NATS Real-time Streaming Demo</h2>
            <p class="text-muted">Live system metrics via NATS streaming - Admin Only</p>
        </div>
    </div>
    
    <!-- Status Panel -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5><i class="fas fa-info-circle"></i> Live Monitoring Status</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Device:</strong> <code>510a188e-ca5b-48cc-8fe7-173f14fa8928</code>
                        </div>
                        <div class="col-md-2">
                            <strong>Status:</strong> <span id="connectionStatus" class="badge badge-success">Live</span>
                        </div>
                        <div class="col-md-2">
                            <strong>Messages:</strong> <span id="messageCount">0</span>
                        </div>
                        <div class="col-md-2">
                            <strong>NATS:</strong> <span id="natsStatus" class="badge badge-success">Running</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Last Update:</strong> <span id="lastUpdateValue">Starting...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Gauges -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6><i class="fas fa-microchip"></i> CPU Usage</h6>
                    <canvas id="cpuGauge" width="150" height="150"></canvas>
                    <div class="mt-2">
                        <span id="cpuValue" class="h5 text-primary">0%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6><i class="fas fa-memory"></i> Memory Usage</h6>
                    <canvas id="memoryGauge" width="150" height="150"></canvas>
                    <div class="mt-2">
                        <span id="memoryValue" class="h5 text-info">0%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6><i class="fas fa-hdd"></i> Disk Usage</h6>
                    <canvas id="diskGauge" width="150" height="150"></canvas>
                    <div class="mt-2">
                        <span id="diskValue" class="h5 text-warning">0%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body text-center">
                    <h6><i class="fas fa-thermometer-half"></i> System Load</h6>
                    <canvas id="loadGauge" width="150" height="150"></canvas>
                    <div class="mt-2">
                        <span id="loadValue" class="h5 text-danger">0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Network Metrics -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <h6><i class="fas fa-arrow-down"></i> Network In</h6>
                    <div class="h4 text-success">
                        <span id="networkInValue">0 B/s</span>
                    </div>
                    <small class="text-muted">Bytes received per second</small>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center">
                    <h6><i class="fas fa-arrow-up"></i> Network Out</h6>
                    <div class="h4 text-danger">
                        <span id="networkOutValue">0 B/s</span>
                    </div>
                    <small class="text-muted">Bytes sent per second</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Agent RPC Controls -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-terminal"></i> Agent Commands</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deviceUuidInput" class="form-label">Device UUID:</label>
                                <input type="text" class="form-control" id="deviceUuidInput"
                                       value="510a188e-ca5b-48cc-8fe7-173f14fa8928" placeholder="Enter device UUID">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Quick Actions:</label><br>
                                <button class="btn btn-primary btn-sm me-2" onclick="sendAgentRPC('osquery', {query: '.tables'})">
                                    <i class="fas fa-table"></i> List Tables
                                </button>
                                <button class="btn btn-info btn-sm me-2" onclick="sendAgentRPC('ping', {})">
                                    <i class="fas fa-heartbeat"></i> Ping
                                </button>
                                <button class="btn btn-success btn-sm" onclick="sendAgentRPC('system_info', {})">
                                    <i class="fas fa-info-circle"></i> System Info
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Query -->
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="customQuery"
                                   placeholder="Enter osquery command (e.g., SELECT name FROM processes LIMIT 10)">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning" onclick="sendCustomQuery()">
                                <i class="fas fa-play"></i> Execute Query
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Display -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-list"></i> Command Results</h6>
                    <div id="rpcResults" class="mt-3">
                        <p class="text-muted">No commands executed yet. Try the buttons above to test agent communication.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Info -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-server"></i> System Information</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Uptime:</strong> <span id="uptimeValue">Unknown</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Last Update:</strong> <span id="lastUpdateValue">Never</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Update Rate:</strong> <span class="text-muted">2 seconds</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Data Points:</strong> <span id="dataPointsValue">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Debug: Test API call -->
<script>
console.log('NATS Demo Dashboard loaded - v2');

// Test API call immediately
fetch('/api/nats-demo/debug')
    .then(response => response.json())
    .then(data => {
        console.log('Debug API response:', data);

        // Update status immediately
        document.getElementById('connectionStatus').textContent = data.running ? 'Live' : 'Stopped';
        document.getElementById('connectionStatus').className = `badge badge-${data.running ? 'success' : 'secondary'}`;
        document.getElementById('messageCount').textContent = data.total_metrics;

        // Show some data if available
        if (data.buffer_info) {
            for (const [key, info] of Object.entries(data.buffer_info)) {
                if (key.includes('cpu_percent') && info.latest) {
                    document.getElementById('cpuValue').textContent = `${info.latest.value.toFixed(1)}%`;
                }
                if (key.includes('memory_percent') && info.latest) {
                    document.getElementById('memoryValue').textContent = `${info.latest.value.toFixed(1)}%`;
                }
                if (key.includes('disk_percent') && info.latest) {
                    document.getElementById('diskValue').textContent = `${info.latest.value.toFixed(1)}%`;
                }
            }
        }
    })
    .catch(error => {
        console.error('API call failed:', error);
        document.getElementById('connectionStatus').textContent = 'Error';
        document.getElementById('connectionStatus').className = 'badge badge-danger';
    });

// Update every 5 seconds
setInterval(() => {
    fetch('/api/nats-demo/debug')
        .then(response => response.json())
        .then(data => {
            document.getElementById('messageCount').textContent = data.total_metrics;
            document.getElementById('lastUpdateValue').textContent = new Date().toLocaleTimeString();

            // Update metrics
            if (data.buffer_info) {
                for (const [key, info] of Object.entries(data.buffer_info)) {
                    if (key.includes('cpu_percent') && info.latest) {
                        document.getElementById('cpuValue').textContent = `${info.latest.value.toFixed(1)}%`;
                    }
                    if (key.includes('memory_percent') && info.latest) {
                        document.getElementById('memoryValue').textContent = `${info.latest.value.toFixed(1)}%`;
                    }
                    if (key.includes('disk_percent') && info.latest) {
                        document.getElementById('diskValue').textContent = `${info.latest.value.toFixed(1)}%`;
                    }
                }
            }
        })
        .catch(error => console.error('Update failed:', error));
}, 5000);

// Agent RPC Functions
async function sendAgentRPC(action, args) {
    const deviceUuid = document.getElementById('deviceUuidInput').value.trim();
    if (!deviceUuid) {
        alert('Please enter a device UUID');
        return;
    }

    const resultsDiv = document.getElementById('rpcResults');
    resultsDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Executing command...</div>';

    try {
        const response = await fetch('/admin/nats-demo/api/agent/rpc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                device_uuid: deviceUuid,
                action: action,
                args: args
            })
        });

        const result = await response.json();
        displayRPCResult(action, result);

    } catch (error) {
        console.error('RPC Error:', error);
        resultsDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
    }
}

function sendCustomQuery() {
    const query = document.getElementById('customQuery').value.trim();
    if (!query) {
        alert('Please enter a query');
        return;
    }

    sendAgentRPC('osquery', { query: query });
}

function displayRPCResult(action, result) {
    const resultsDiv = document.getElementById('rpcResults');

    if (result.error) {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <strong>Error:</strong> ${result.error}
            </div>
        `;
        return;
    }

    let html = `<div class="alert alert-success mb-3">
        <strong>Command:</strong> ${action}
        <span class="badge badge-info ms-2">${result.status || 'completed'}</span>
    </div>`;

    if (action === 'osquery' && result.data) {
        if (result.data.output) {
            html += `
                <div class="card">
                    <div class="card-header">
                        <strong>Query:</strong> ${result.data.query || 'N/A'}
                    </div>
                    <div class="card-body">
                        <pre class="bg-light p-3" style="max-height: 400px; overflow-y: auto;">${result.data.output}</pre>
                    </div>
                </div>
            `;
        } else if (result.data.error) {
            html += `<div class="alert alert-warning">${result.data.error}</div>`;
        }
    } else if (action === 'ping' && result.data) {
        html += `
            <div class="card">
                <div class="card-body">
                    <p><strong>Pong:</strong> ${result.data.pong ? 'Yes' : 'No'}</p>
                    <p><strong>Timestamp:</strong> ${new Date(result.data.timestamp).toLocaleString()}</p>
                    <p><strong>Session ID:</strong> ${result.data.session_id}</p>
                </div>
            </div>
        `;
    } else if (action === 'system_info' && result.data) {
        html += `
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Platform:</strong> ${result.data.platform || 'N/A'}</p>
                            <p><strong>System:</strong> ${result.data.system || 'N/A'}</p>
                            <p><strong>Release:</strong> ${result.data.release || 'N/A'}</p>
                            <p><strong>Machine:</strong> ${result.data.machine || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Hostname:</strong> ${result.data.hostname || 'N/A'}</p>
                            <p><strong>Agent Version:</strong> ${result.data.agent_version || 'N/A'}</p>
                            <p><strong>Device UUID:</strong> ${result.data.device_uuid || 'N/A'}</p>
                            <p><strong>Tenant UUID:</strong> ${result.data.tenant_uuid || 'N/A'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // Generic JSON display
        html += `
            <div class="card">
                <div class="card-body">
                    <pre class="bg-light p-3">${JSON.stringify(result, null, 2)}</pre>
                </div>
            </div>
        `;
    }

    resultsDiv.innerHTML = html;
}
</script>

<script src="{{ url_for('static', filename='js/nats_demo_realtime.js') }}"></script>
{% endblock %}
