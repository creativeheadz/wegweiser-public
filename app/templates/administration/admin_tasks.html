<!-- Filepath: app/templates/administration/admin_tasks.html -->
{% extends "base.html" %}
{% block title %}Task Management - Wegweiser{% endblock %}
{% block content %}

<div class="main-content">
    <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
        <div class="breadcrumb-title pe-3">Task Management</div>
        <div class="ps-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 p-0">
                    <li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i></a></li>
                    <li class="breadcrumb-item active" aria-current="page">Manage Tasks</li>
                </ol>
            </nav>
        </div>
        <div class="ms-auto">
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                Add New Task
            </button>
        </div>
    </div>

    <div class="card rounded-4">
        <div class="card-body">
            <h4 class="card-title">Task Mappings</h4>
            <div class="table-responsive">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th>Task Name</th>
                            <th>Metalogos Type</th>
                            <th>OS Types</th>
                            <th>Description</th>
                            <th>Analysis Module</th>
                            <th>Analysis Function</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="taskTableBody">
                        {% for task in tasks %}
                        <tr>
                            <td>{{ task.task_name }}</td>
                            <td>{{ task.metalogos_type }}</td>
                            <td>{{ task.os_types }}</td>
                            <td>{{ task.description }}</td>
                            <td>{{ task.analysis_module }}</td>
                            <td>{{ task.analysis_function }}</td>
                            <td>
                                <button class="btn btn-danger btn-sm delete-task" data-task-name="{{ task.task_name }}">Delete</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">Task Name</label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="metalogosType" class="form-label">Metalogos Type</label>
                        <input type="text" class="form-control" id="metalogosType" required>
                    </div>
                    <div class="mb-3">
                        <label for="osTypes" class="form-label">OS Types</label>
                        <input type="text" class="form-control" id="osTypes" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="analysisModule" class="form-label">Analysis Module</label>
                        <input type="text" class="form-control" id="analysisModule" required>
                    </div>
                    <div class="mb-3">
                        <label for="analysisFunction" class="form-label">Analysis Function</label>
                        <input type="text" class="form-control" id="analysisFunction" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addTaskForm = document.getElementById('addTaskForm');
    const taskTableBody = document.getElementById('taskTableBody');

    addTaskForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = {
            task_name: document.getElementById('taskName').value,
            metalogos_type: document.getElementById('metalogosType').value,
            os_types: document.getElementById('osTypes').value,
            description: document.getElementById('description').value,
            analysis_module: document.getElementById('analysisModule').value,
            analysis_function: document.getElementById('analysisFunction').value
        };

        fetch('/admin/tasks/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add the new task to the table
                const newRow = taskTableBody.insertRow();
                newRow.innerHTML = `
                    <td>${formData.task_name}</td>
                    <td>${formData.metalogos_type}</td>
                    <td>${formData.os_types}</td>
                    <td>${formData.description}</td>
                    <td>${formData.analysis_module}</td>
                    <td>${formData.analysis_function}</td>
                    <td><button class="btn btn-danger btn-sm delete-task" data-task-name="${formData.task_name}">Delete</button></td>
                `;
                // Close the modal
                var modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
                modal.hide();
                // Reset the form
                addTaskForm.reset();
            } else {
                alert('Failed to add task: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while adding the task');
        });
    });

    // Event delegation for delete buttons
    taskTableBody.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-task')) {
            const taskName = e.target.getAttribute('data-task-name');
            if (confirm(`Are you sure you want to delete the task "${taskName}"?`)) {
                // Send delete request to server
                fetch('/admin/tasks/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ task_name: taskName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the row from the table
                        e.target.closest('tr').remove();
                    } else {
                        alert('Failed to delete task: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while deleting the task');
                });
            }
        }
    });
});
</script>
{% endblock %}