<!-- Filepath: app/templates/groups/index-single-group.html -->
{% extends "base.html" %}
{% block title %}Group Management - Wegweiser{% endblock %}
{% block extra_head %}
<!-- uPlot CSS already loaded in base.html - removed duplicate -->
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

{% endblock %}

{% block content %}
<div class="main-content">
    {% call breadcrumb(title='Administration', items=[
    {'text': 'Group Management', 'icon': 'fas fa-users', 'url': url_for('groups_bp.groups_page')},
    {'text': group.groupname}
    ]) %}
    {% endcall %}

    {# General Information Section #}
    <div id="general-info-{{ group.groupuuid }}" class="mb-4">
        <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0">{{ group.groupname }}</h4>
        </div>

        <div class="row g-4">
            {# Modern Health Score Gauge #}
            <div class="col-lg-6">
                <div class="modern-gauge-card">
                    <div class="modern-gauge-content">
                        <div class="modern-gauge-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="modern-gauge-info">
                            <div class="modern-gauge-label">Group Health Score</div>
                            <div class="modern-gauge-value" id="health-score-value-group">{% if group.health_score is not none %}{{ "%.0f"|format(group.health_score) }}%{% else %}N/A{% endif %}</div>
                            <div class="modern-gauge-bar">
                                <div class="modern-gauge-bar-fill" id="health-score-bar-group" style="width: {{ group.health_score|default(0) }}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {# Modern Health History Chart #}
            <div class="col-lg-6">
                <div class="modern-chart-card">
                    <div class="modern-chart-header">
                        <div class="modern-chart-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <span class="modern-chart-title">Group Health Score History</span>
                    </div>
                    <div class="modern-chart-body">
                        <div id="group-health-history" class="modern-chart-container"
                             data-group-uuid="{{ group.groupuuid }}"
                             data-health-score="{{ group.health_score|default(0) }}"></div>
                    </div>
                </div>
            </div>
        </div>

        {# Group Overview #}
        <div class="card shadow mt-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="text-muted">Organisation</div>
                            <div class="fw-bold">{{ org.orgname }}</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-muted">Device Count</div>
                            <div class="fw-bold">{{ group.devices|length }}</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <div class="text-muted">Created At</div>
                            <div class="fw-bold">{{ group.created_at }}</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-muted">Group UUID</div>
                            <div class="input-group">
                                <input type="text" class="form-control" id="groupUUID" value="{{ group.groupuuid }}"
                                    readonly>
                                <button class="btn btn-outline-secondary" type="button" id="copyUUIDBtn"
                                    data-copy="input" data-copy-target="groupUUID"
                                    data-copy-message="Group UUID copied to clipboard!">Copy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Deployment Section #}
    <div id="deployment-{{ group.groupuuid }}" class="mb-4">
        <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0">Deployment Instructions</h4>
        </div>
        <div class="card shadow">
            <div class="card-body">
                {# Linux Installation #}
                <div class="mb-4">
                    <h5 class="d-flex align-items-center mb-3">
                        <i class="fab fa-linux me-2"></i>Linux Installation
                    </h5>
                    <div class="code-box">
                        <pre class="has-copy-button"><code class="language-bash" id="linux-code-{{ group.groupuuid }}">curl -o /tmp/installAgent.sh https://app.wegweiser.tech/download/installAgent.sh && sudo sh /tmp/installAgent.sh {{ group.groupuuid }}</code></pre>
                        <button class="btn btn-sm btn-outline-secondary mt-2" data-copy="code"
                            data-copy-target="linux-code-{{ group.groupuuid }}"
                            data-copy-message="Linux installation command copied to clipboard!">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                </div>

                {# Windows Installation #}
                <div class="mb-4">
                    <h5 class="d-flex align-items-center mb-3">
                        <i class="fab fa-windows me-2"></i>Windows Installation
                    </h5>
                    <div class="code-box">
                        <pre class="has-copy-button"><code class="language-powershell" id="windows-code-{{ group.groupuuid }}">curl -o %temp%\wegweiserAgentInstaller.exe https://app.wegweiser.tech/download/wegweiserAgentInstaller.exe && %temp%\wegweiserAgentInstaller.exe /groupuuid={{ group.groupuuid }} /serverAddr=app.wegweiser.tech /LOG=%temp%\WegweiserSetup.log /SILENT</code></pre>
                        <button class="btn btn-sm btn-outline-secondary mt-2" data-copy="code"
                            data-copy-target="windows-code-{{ group.groupuuid }}"
                            data-copy-message="Windows installation command copied to clipboard!">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                </div>

                {# macOS Installation #}
                <div>
                    <h5 class="d-flex align-items-center mb-3">
                        <i class="fab fa-apple me-2"></i>macOS Installation
                    </h5>
                    <div class="code-box">
                        <pre class="has-copy-button"><code class="language-bash" id="macos-code-{{ group.groupuuid }}">curl -o installAgent-macos.sh https://app.wegweiser.tech/download/installAgent-macos.sh && chmod +x installAgent-macos.sh && sudo ./installAgent-macos.sh {{ group.groupuuid }}</code></pre>
                        <button class="btn btn-sm btn-outline-secondary mt-2" data-copy="code"
                            data-copy-target="macos-code-{{ group.groupuuid }}"
                            data-copy-message="macOS installation command copied to clipboard!">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {# Devices Section #}
    <div id="devices-{{ group.groupuuid }}" class="mb-4">
        <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0">Devices</h4>
        </div>
        <div class="card shadow">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead>
                            <tr>
                                <th>Device Name</th>
                                <th>Health Score</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if group.devices %}
                            {% for device in group.devices %}
                            <tr>
                                <td>{{ device.devicename }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 5px;">
                                            <div class="progress-bar bg-primary" role="progressbar"
                                                style="width: {{ device.health_score|default(0) }}%"></div>
                                        </div>
                                        <span class="small">{% if device.health_score is not none %}{{ "%.0f"|format(device.health_score) }}%{% else %}N/A{% endif %}</span>
                                    </div>
                                </td>
                                <td>
                                    <a href="{{url_for('devices_bp.view_device', deviceuuid=device.deviceuuid) }}"
                                        class="btn btn-sm btn-outline-primary">View</a>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">No devices in this group.</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {# Group Analyses Section #}
    <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
            <h4 class="mb-0">AI Analyses for {{ group.groupname }}</h4>
        </div>
        <div class="row g-4" id="dynamic-group-analyses-grid">
            <!-- Dynamic group analyses cards will be loaded here -->
        </div>
    </div>



    {# Include the shared chat component #}
    {% with entity_type='group', entity_uuid=group.groupuuid, entity_name=group.groupname %}
    {% include "components/chat_component.html" %}
    {% endwith %}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    window.group_uuid = "{{ group.groupuuid }}";
</script>
{% include "groups/scripts.html" %}
<script src="{{ url_for('static', filename='js/scroll-to-top.js') }}"></script>

{# Include the shared chat initialization script #}
{% with entity_type='group', entity_uuid=group.groupuuid, entity_name=group.groupname %}
{% include "components/chat_init.html" %}
{% endwith %}
{% endblock %}