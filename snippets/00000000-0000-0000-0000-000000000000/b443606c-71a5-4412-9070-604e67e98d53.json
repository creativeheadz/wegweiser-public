{"settings": {"snippetUuid": "b443606c-71a5-4412-9070-604e67e98d53", "snippetname": "Loki", "snippettype": ".py", "created_at": 1763468252}, "payload": {"payloadsig": "pOETH6/SAU2wl9MKphyeXmJOai+GzWpw8IXFKJxGzG2f7DGOtonUabsCo5l6xRGFWiaVH5qG6CKzs5TL+cfHLMhOuhy1TZaNvbIXUKTCByexeZKe4ktw2Y0G9AUysm0Iq9ZLD4f4bow1Og4HnGonN7rwg0UoJgo3/8K74H7cD5XRJOm3BbPpi/W2tIoZvUeRBZo/7WADbYLC1bIB+WJ6AJVX5ooxRAtEQjyb/LUggjBm8C/lkWmtoSRUAsuRDwWydi38VzHw1bqZeva1QT9zRN1VCFHFkL9QSrzQYw1D1w9O+RGJm1QlfuqYaJ/bJM700MF/Y1ekCeNWBtuLsr/9bUlec5tuWIeDED/M7Gli88GSXQQGkmg9uOVnff7+1I571Y/HE9RZH3rnv15YMAov8yrXY/ZQlysJqeq3LpJKSEDNNuum4qmecpTl45FnbuPSN8fAcLEpVr8Ruv3zL50jtfD9c6hwtc7cPWqFZYnT9nEHoipqhVeomgrfjQu7W1gunuWaSJYFDGFfPdRUGzXuGujpXvcOXM4T5CiDsxUaBOp1wsHRSs9l5VVF4LfKgPIUvCthvBRIql8djaLfP12AB8XYRZG4uK0/OEGN0YfZURhuuLLJulgIIrmak5w/ZLtADPHdz42vWzTDC6oIhjWcr3M51KhPMB31I01nEHOtx5s=", "payloadb64": "IyBGaWxlcGF0aDogc25pcHBldHMvdW5TaWduZWQvTG9raS5weQojIS91c3IvYmluL2VudiBweXRob24zCmltcG9ydCBwbGF0Zm9ybQpmcm9tIGxvZ3plcm8gaW1wb3J0IGxvZ2dlciwgbG9nZmlsZQppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IHppcGZpbGUKaW1wb3J0IHJlcXVlc3RzCmltcG9ydCBzeXMKaW1wb3J0IHN1YnByb2Nlc3MKaW1wb3J0IHNodXRpbApmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQppbXBvcnQgYXN5bmNpbwppbXBvcnQgdXVpZAppbXBvcnQgdGltZQoKCiMgUmVwbGFjZSB0aGUgcGxhdGZvcm0tc3BlY2lmaWMgQkFTRV9ESVIgd2l0aCBhIG1vcmUgZmxleGlibGUgYXBwcm9hY2gKQkFTRV9ESVIgPSBvcy5nZXRlbnYoJ1dFR1dFSVNFUl9CQVNFX0RJUicsICcvb3B0L1dlZ3dlaXNlcicpCgojIEVuc3VyZSBBZ2VudCBjb3JlIGlzIGltcG9ydGFibGUgc28gd2UgY2FuIHVzZSBUb29sTWFuYWdlciBmcm9tIGluc2lkZSBhIHNuaXBwZXQKQUdFTlRfRElSID0gb3MucGF0aC5qb2luKEJBU0VfRElSLCAnQWdlbnQnKQppZiBBR0VOVF9ESVIgbm90IGluIHN5cy5wYXRoOgogICAgc3lzLnBhdGguaW5zZXJ0KDAsIEFHRU5UX0RJUikKCnRyeToKICAgIGZyb20gY29yZS50b29sX21hbmFnZXIgaW1wb3J0IFRvb2xNYW5hZ2VyCmV4Y2VwdCBJbXBvcnRFcnJvcjoKICAgIFRvb2xNYW5hZ2VyID0gTm9uZQoKCmRlZiBsb2dfbWVzc2FnZShtc2cpOgogICAgIiIiTG9nIGEgbWVzc2FnZSB1c2luZyBsb2d6ZXJvIGxvZ2dlciIiIgogICAgbG9nZ2VyLmluZm8oZiJMT0tJOiB7bXNnfSIpCgpkZWYgZ2V0QXBwRGlycygpOgogICAgIiIiR2V0IGFwcGxpY2F0aW9uIGRpcmVjdG9yaWVzIGJhc2VkIG9uIEJBU0VfRElSIiIiCiAgICAjIFRyeSB0byBnZXQgZGlyZWN0b3J5IGZyb20gZW52aXJvbm1lbnQgZmlyc3QKICAgIGFwcERpciA9IG9zLmdldGVudignV0VHV0VJU0VSX0JBU0VfRElSJywgQkFTRV9ESVIpCgogICAgIyBFbnN1cmUgdGhlIGJhc2UgZGlyZWN0b3J5IGV4aXN0cwogICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGFwcERpcik6CiAgICAgICAgZmFsbGJhY2tfZGlycyA9IFsKICAgICAgICAgICAgJy9vcHQvV2Vnd2Vpc2VyJywKICAgICAgICAgICAgJy9BcHBsaWNhdGlvbnMvV2Vnd2Vpc2VyJywKICAgICAgICAgICAgcidDOlxQcm9ncmFtIEZpbGVzICh4ODYpXFdlZ3dlaXNlcicKICAgICAgICBdCiAgICAgICAgZm9yIGQgaW4gZmFsbGJhY2tfZGlyczoKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoZCk6CiAgICAgICAgICAgICAgICBhcHBEaXIgPSBkCiAgICAgICAgICAgICAgICBicmVhawoKICAgIGlmIG5vdCBhcHBEaXIuZW5kc3dpdGgob3Muc2VwKToKICAgICAgICBhcHBEaXIgKz0gb3Muc2VwCgogICAgbG9nRGlyID0gb3MucGF0aC5qb2luKGFwcERpciwgJ0xvZ3MnLCAnJykKICAgIGNvbmZpZ0RpciA9IG9zLnBhdGguam9pbihhcHBEaXIsICdDb25maWcnLCAnJykKICAgIGZpbGVzRGlyID0gb3MucGF0aC5qb2luKGFwcERpciwgJ0ZpbGVzJywgJycpCiAgICBzY3JpcHRzRGlyID0gb3MucGF0aC5qb2luKGFwcERpciwgJ1NjcmlwdHMnLCAnJykKICAgIHRlbXBEaXIgPSBvcy5wYXRoLmpvaW4oYXBwRGlyLCAnVGVtcCcsICcnKQogICAgcmV0dXJuIGFwcERpciwgbG9nRGlyLCBjb25maWdEaXIsIHRlbXBEaXIsIGZpbGVzRGlyLCBzY3JpcHRzRGlyCgpkZWYgY2hlY2tfbmV0d29yaygpOgogICAgIiIiQ2hlY2sgaWYgdGhlIG5ldHdvcmsgaXMgYXZhaWxhYmxlIGJ5IHBpbmdpbmcgYW4gZXh0ZXJuYWwgVVJMIiIiCiAgICB0cnk6CiAgICAgICAgcmVxdWVzdHMuZ2V0KCJodHRwczovL3d3dy5nb29nbGUuY29tIiwgdGltZW91dD01KQogICAgICAgIHJldHVybiBUcnVlCiAgICBleGNlcHQgcmVxdWVzdHMuQ29ubmVjdGlvbkVycm9yOgogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIGdldERldmljZVV1aWQoKToKICAgICIiIlJldHJpZXZlIHRoZSBkZXZpY2UgVVVJRCBhbmQgc2VydmVyIGFkZHJlc3MgZnJvbSB0aGUgY29uZmlndXJhdGlvbiBmaWxlIiIiCiAgICBhcHBEaXIsIGxvZ0RpciwgY29uZmlnRGlyLCB0ZW1wRGlyLCBmaWxlc0Rpciwgc2NyaXB0c0RpciA9IGdldEFwcERpcnMoKQogICAgbG9nX21lc3NhZ2UoZiJSZWFkaW5nIGNvbmZpZyBmcm9tIHtjb25maWdEaXJ9IikKCiAgICAjIEFkZCBhZGRpdGlvbmFsIGNvbmZpZyBmaWxlIGxvY2F0aW9ucyB0byB0cnkKICAgIGNvbmZpZ19sb2NhdGlvbnMgPSBbCiAgICAgICAgb3MucGF0aC5qb2luKGNvbmZpZ0RpciwgJ2FnZW50LmNvbmZpZycpLAogICAgICAgICcvZXRjL3dlZ3dlaXNlci9hZ2VudC5jb25maWcnLAogICAgICAgIG9zLnBhdGguZXhwYW5kdXNlcignfi8uY29uZmlnL3dlZ3dlaXNlci9hZ2VudC5jb25maWcnKQogICAgXQoKICAgIGZvciBjb25maWdfZmlsZSBpbiBjb25maWdfbG9jYXRpb25zOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKGNvbmZpZ19maWxlKSBhcyBmOgogICAgICAgICAgICAgICAgYWdlbnRDb25maWdEaWN0ID0ganNvbi5sb2FkKGYpCiAgICAgICAgICAgICAgICBsb2dfbWVzc2FnZShmIlN1Y2Nlc3NmdWxseSByZWFkIGNvbmZpZyBmcm9tIHtjb25maWdfZmlsZX0iKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBleGNlcHQgKEZpbGVOb3RGb3VuZEVycm9yLCBqc29uLkpTT05EZWNvZGVFcnJvcikgYXMgZToKICAgICAgICAgICAgY29udGludWUKICAgIGVsc2U6CiAgICAgICAgbG9nX21lc3NhZ2UoIkVycm9yOiBDb3VsZCBub3QgZmluZCB2YWxpZCBhZ2VudC5jb25maWcgaW4gYW55IGxvY2F0aW9uIikKICAgICAgICBzeXMuZXhpdCgxKQoKICAgIGRldmljZVV1aWQgPSBhZ2VudENvbmZpZ0RpY3QuZ2V0KCdkZXZpY2V1dWlkJykKICAgIGhvc3QgPSBhZ2VudENvbmZpZ0RpY3QuZ2V0KCdzZXJ2ZXJBZGRyJywgJ2FwcC53ZWd3ZWlzZXIudGVjaCcpCiAgICByZXR1cm4gZGV2aWNlVXVpZCwgaG9zdAoKZGVmIHBhcnNlX2xva2lfb3V0cHV0KG91dHB1dF90ZXh0KToKICAgICIiIlBhcnNlIExva2kncyBDU1Ygb3V0cHV0IGludG8gYSBzdHJ1Y3R1cmVkIGZvcm1hdCIiIgogICAgcmVzdWx0cyA9IHsKICAgICAgICAnYWxlcnRzJzogW10sCiAgICAgICAgJ3dhcm5pbmdzJzogW10sCiAgICAgICAgJ25vdGljZXMnOiBbXSwKICAgICAgICAnc2Nhbl90aW1lJzogZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCksCiAgICAgICAgJ3N1bW1hcnknOiB7CiAgICAgICAgICAgICd0b3RhbF9hbGVydHMnOiAwLAogICAgICAgICAgICAndG90YWxfd2FybmluZ3MnOiAwLAogICAgICAgICAgICAndG90YWxfbm90aWNlcyc6IDAKICAgICAgICB9CiAgICB9CgogICAgZm9yIGxpbmUgaW4gb3V0cHV0X3RleHQuc3BsaXQoJ1xuJyk6CiAgICAgICAgaWYgbm90IGxpbmUuc3RyaXAoKToKICAgICAgICAgICAgY29udGludWUKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwYXJ0cyA9IGxpbmUuc3BsaXQoJywnKQogICAgICAgICAgICBpZiBsZW4ocGFydHMpID49IDQ6CiAgICAgICAgICAgICAgICB0aW1lc3RhbXAsIGhvc3RuYW1lLCBsZXZlbCwgbWVzc2FnZSA9IHBhcnRzWzA6NF0KICAgICAgICAgICAgICAgIGV2ZW50ID0gewogICAgICAgICAgICAgICAgICAgICd0aW1lc3RhbXAnOiB0aW1lc3RhbXAsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBtZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICdkZXRhaWxzJzogJywnLmpvaW4ocGFydHNbNDpdKSBpZiBsZW4ocGFydHMpID4gNCBlbHNlICcnCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgbGV2ZWwgPT0gJ0FMRVJUJzoKICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydhbGVydHMnXS5hcHBlbmQoZXZlbnQpCiAgICAgICAgICAgICAgICAgICAgcmVzdWx0c1snc3VtbWFyeSddWyd0b3RhbF9hbGVydHMnXSArPSAxCiAgICAgICAgICAgICAgICBlbGlmIGxldmVsID09ICdXQVJOSU5HJzoKICAgICAgICAgICAgICAgICAgICByZXN1bHRzWyd3YXJuaW5ncyddLmFwcGVuZChldmVudCkKICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydzdW1tYXJ5J11bJ3RvdGFsX3dhcm5pbmdzJ10gKz0gMQogICAgICAgICAgICAgICAgZWxpZiBsZXZlbCA9PSAnTk9USUNFJzoKICAgICAgICAgICAgICAgICAgICByZXN1bHRzWydub3RpY2VzJ10uYXBwZW5kKGV2ZW50KQogICAgICAgICAgICAgICAgICAgIHJlc3VsdHNbJ3N1bW1hcnknXVsndG90YWxfbm90aWNlcyddICs9IDEKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dfbWVzc2FnZShmIkVycm9yIHBhcnNpbmcgbGluZToge2xpbmV9LCBFcnJvcjoge3N0cihlKX0iKQoKICAgIHJldHVybiByZXN1bHRzCgpkZWYgc2VuZF9tZXRhZGF0YShkZXZpY2VVdWlkLCBob3N0LCBsb2tpX3Jlc3VsdHMpOgogICAgIiIiU2VuZCBMb2tpIHJlc3VsdHMgdG8gdGhlIG1ldGFkYXRhIGVuZHBvaW50IiIiCiAgICB0cnk6CiAgICAgICAgYm9keSA9IHsKICAgICAgICAgICAgJ2RldmljZXV1aWQnOiBkZXZpY2VVdWlkLAogICAgICAgICAgICAnbWV0YWxvZ29zX3R5cGUnOiAnbG9raS1zY2FuJywKICAgICAgICAgICAgJ21ldGFsb2dvcyc6IGxva2lfcmVzdWx0cwogICAgICAgIH0KCiAgICAgICAgdXJsID0gZidodHRwczovL3tob3N0fS9haS9kZXZpY2UvbWV0YWRhdGEnCiAgICAgICAgaGVhZGVycyA9IHsnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nfQogICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdCh1cmwsIGhlYWRlcnM9aGVhZGVycywgZGF0YT1qc29uLmR1bXBzKGJvZHkpKQoKICAgICAgICBpZiByZXNwb25zZS5zdGF0dXNfY29kZSBpbiBbMjAwLCAyMDFdOgogICAgICAgICAgICBsb2dfbWVzc2FnZSgiU3VjY2Vzc2Z1bGx5IHNlbnQgTG9raSByZXN1bHRzIHRvIHNlcnZlciIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nX21lc3NhZ2UoZiJGYWlsZWQgdG8gc2VuZCByZXN1bHRzLiBTdGF0dXMgY29kZToge3Jlc3BvbnNlLnN0YXR1c19jb2RlfSIpCgogICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXNfY29kZQoKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfbWVzc2FnZShmIkVycm9yIHNlbmRpbmcgbWV0YWRhdGE6IHtzdHIoZSl9IikKICAgICAgICByZXR1cm4gTm9uZQoKZGVmIF9nZXRfcXVldWVfcGF0aChjb25maWdEaXIpOgogICAgIiIiUmV0dXJuIHBhdGggdG8gTG9raSBzY2FuIHF1ZXVlIGZpbGUuIiIiCiAgICByZXR1cm4gb3MucGF0aC5qb2luKGNvbmZpZ0RpciwgImxva2lfcXVldWUuanNvbiIpCgoKZGVmIF9sb2FkX3F1ZXVlKHF1ZXVlX3BhdGgpOgogICAgIiIiTG9hZCBMb2tpIHNjYW4gcXVldWUgZnJvbSBKU09OIGZpbGUuIiIiCiAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMocXVldWVfcGF0aCk6CiAgICAgICAgcmV0dXJuIHsidmVyc2lvbiI6IDEsICJqb2JzIjogW119CiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHF1ZXVlX3BhdGgsICJyIikgYXMgZjoKICAgICAgICAgICAgZGF0YSA9IGpzb24ubG9hZChmKQogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGRhdGEsIGRpY3QpOgogICAgICAgICAgICByZXR1cm4geyJ2ZXJzaW9uIjogMSwgImpvYnMiOiBbXX0KICAgICAgICBqb2JzID0gZGF0YS5nZXQoImpvYnMiLCBbXSkKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShqb2JzLCBsaXN0KToKICAgICAgICAgICAgam9icyA9IFtdCiAgICAgICAgZGF0YVsiam9icyJdID0gam9icwogICAgICAgIHJldHVybiBkYXRhCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgbG9nX21lc3NhZ2UoZiJGYWlsZWQgdG8gbG9hZCBMb2tpIHF1ZXVlIGZyb20ge3F1ZXVlX3BhdGh9OiB7ZX0iKQogICAgICAgIHJldHVybiB7InZlcnNpb24iOiAxLCAiam9icyI6IFtdfQoKCmRlZiBfc2F2ZV9xdWV1ZShxdWV1ZV9wYXRoLCBxdWV1ZV9kYXRhKToKICAgICIiIlBlcnNpc3QgTG9raSBxdWV1ZSBhdG9taWNhbGx5LiIiIgogICAgdG1wX3BhdGggPSBxdWV1ZV9wYXRoICsgIi50bXAiCiAgICB0cnk6CiAgICAgICAgb3MubWFrZWRpcnMob3MucGF0aC5kaXJuYW1lKHF1ZXVlX3BhdGgpLCBleGlzdF9vaz1UcnVlKQogICAgICAgIHdpdGggb3Blbih0bXBfcGF0aCwgInciKSBhcyBmOgogICAgICAgICAgICBqc29uLmR1bXAocXVldWVfZGF0YSwgZiwgaW5kZW50PTIpCiAgICAgICAgb3MucmVwbGFjZSh0bXBfcGF0aCwgcXVldWVfcGF0aCkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBsb2dfbWVzc2FnZShmIkZhaWxlZCB0byBzYXZlIExva2kgcXVldWUgdG8ge3F1ZXVlX3BhdGh9OiB7ZX0iKQoKCmRlZiBfZ2V0X25leHRfcGVuZGluZ19qb2IocXVldWVfZGF0YSk6CiAgICAiIiJSZXR1cm4gdGhlIGZpcnN0IHBlbmRpbmcgTG9raSBqb2Igb3IgTm9uZS4iIiIKICAgIGZvciBqb2IgaW4gcXVldWVfZGF0YS5nZXQoImpvYnMiLCBbXSk6CiAgICAgICAgc3RhdHVzID0gam9iLmdldCgic3RhdHVzIiwgInBlbmRpbmciKQogICAgICAgIGlmIHN0YXR1cyBpbiAoTm9uZSwgInBlbmRpbmciKToKICAgICAgICAgICAgcmV0dXJuIGpvYgogICAgcmV0dXJuIE5vbmUKCgpkZWYgX3VwZGF0ZV9qb2Jfc3RhdHVzKHF1ZXVlX2RhdGEsIGpvYl9pZCwgc3RhdHVzLCBlcnJvcj1Ob25lKToKICAgICIiIlVwZGF0ZSBzdGF0dXMgbWV0YWRhdGEgZm9yIGEgam9iIGluIHRoZSBMb2tpIHF1ZXVlLiIiIgogICAgbm93ID0gZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCkKICAgIGZvciBqb2IgaW4gcXVldWVfZGF0YS5nZXQoImpvYnMiLCBbXSk6CiAgICAgICAgaWYgam9iLmdldCgiaWQiKSA9PSBqb2JfaWQ6CiAgICAgICAgICAgIGpvYlsic3RhdHVzIl0gPSBzdGF0dXMKICAgICAgICAgICAgam9iWyJ1cGRhdGVkX2F0Il0gPSBub3cKICAgICAgICAgICAgaWYgZXJyb3I6CiAgICAgICAgICAgICAgICBqb2JbImxhc3RfZXJyb3IiXSA9IHN0cihlcnJvcikKICAgICAgICAgICAgYnJlYWsKCmRlZiBkZXBsb3lfYW5kX3J1bl9sb2tpKCk6CiAgICAiIiJRdWV1ZS1kcml2ZW4gTG9raSBleGVjdXRpb24gZW50cnlwb2ludC4KCiAgICBUaGlzIHNuaXBwZXQgaXMgaW50ZW50aW9uYWxseSBzaW1wbGUgYW5kIGltbXV0YWJsZToKICAgIC0gUmVhZHMgYSBsb2NhbCBKU09OIHF1ZXVlIG9mIHNjYW4gam9icyBmcm9tIENvbmZpZy9sb2tpX3F1ZXVlLmpzb24KICAgIC0gVXNlcyBUb29sTWFuYWdlciB0byBkb3dubG9hZC9sb2NhdGUgdGhlIExva2kgdG9vbCBidW5kbGUKICAgIC0gRXhlY3V0ZXMgYSBzaW5nbGUgcGVuZGluZyBqb2IgKGlmIGFueSkKICAgICIiIgogICAgYXBwRGlyLCBsb2dEaXIsIGNvbmZpZ0RpciwgdGVtcERpciwgZmlsZXNEaXIsIHNjcmlwdHNEaXIgPSBnZXRBcHBEaXJzKCkKCiAgICAjIEVuc3VyZSBsb2cgZGlyZWN0b3J5IGV4aXN0cwogICAgb3MubWFrZWRpcnMobG9nRGlyLCBleGlzdF9vaz1UcnVlKQoKICAgICMgU2V0IHVwIGxvZ2ZpbGUgZm9yIHRoZSBMb2tpIHdvcmtlcgogICAgbG9nX2ZpbGVfcGF0aCA9IG9zLnBhdGguam9pbihsb2dEaXIsICJsb2tpX3dvcmtlci5sb2ciKQogICAgbG9nZmlsZShsb2dfZmlsZV9wYXRoKQoKICAgIGxvZ19tZXNzYWdlKCJTdGFydGluZyBMb2tpIHF1ZXVlIHdvcmtlciBzbmlwcGV0IikKCiAgICAjIExvYWQgcXVldWUgYW5kIGdldCBuZXh0IGpvYgogICAgcXVldWVfcGF0aCA9IF9nZXRfcXVldWVfcGF0aChjb25maWdEaXIpCiAgICBxdWV1ZV9kYXRhID0gX2xvYWRfcXVldWUocXVldWVfcGF0aCkKCiAgICBqb2IgPSBfZ2V0X25leHRfcGVuZGluZ19qb2IocXVldWVfZGF0YSkKICAgIGlmIG5vdCBqb2I6CiAgICAgICAgIyBGb3Igbm93LCBpZiB0aGVyZSBpcyBubyBwZW5kaW5nIGpvYiwgZW5xdWV1ZSBhIGRlZmF1bHQgdGVzdCBqb2Igc28KICAgICAgICAjIHRoZSBzbmlwcGV0IGNhbiBiZSB1c2VkIGltbWVkaWF0ZWx5IGZvciBtYW51YWwgdGVzdGluZyB2aWEgdGhlCiAgICAgICAgIyBzY2hlZHVsZXIuIEluIGZ1dHVyZSBpdGVyYXRpb25zLCBqb2JzIHdpbGwgbm9ybWFsbHkgYmUgY3JlYXRlZCBieQogICAgICAgICMgdGhlIE5BVFMvY29tbWFuZCBsYXllci4KICAgICAgICBqb2IgPSB7CiAgICAgICAgICAgICJpZCI6IHN0cih1dWlkLnV1aWQ0KCkpLAogICAgICAgICAgICAicGFyYW1ldGVycyI6IHsidGVzdCI6IFRydWV9LAogICAgICAgICAgICAic3RhdHVzIjogInBlbmRpbmciLAogICAgICAgICAgICAiY3JlYXRlZF9hdCI6IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpLAogICAgICAgICAgICAidXBkYXRlZF9hdCI6IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpLAogICAgICAgIH0KICAgICAgICBxdWV1ZV9kYXRhLnNldGRlZmF1bHQoImpvYnMiLCBbXSkuYXBwZW5kKGpvYikKICAgICAgICBfc2F2ZV9xdWV1ZShxdWV1ZV9wYXRoLCBxdWV1ZV9kYXRhKQogICAgICAgIGxvZ19tZXNzYWdlKGYiRW5xdWV1ZWQgZGVmYXVsdCBMb2tpIHRlc3Qgam9iIHtqb2JbJ2lkJ119IGFzIG5vIGpvYnMgd2VyZSBwZW5kaW5nLiIpCgogICAgIyBJbml0aWFsaXplIGpvYiBtZXRhZGF0YQogICAgam9iX2lkID0gam9iLmdldCgiaWQiKSBvciBzdHIodXVpZC51dWlkNCgpKQogICAgam9iWyJpZCJdID0gam9iX2lkCiAgICBub3dfaXNvID0gZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCkKICAgIGpvYi5zZXRkZWZhdWx0KCJjcmVhdGVkX2F0Iiwgbm93X2lzbykKICAgIGpvYlsidXBkYXRlZF9hdCJdID0gbm93X2lzbwogICAgam9iWyJzdGF0dXMiXSA9ICJydW5uaW5nIgogICAgX3NhdmVfcXVldWUocXVldWVfcGF0aCwgcXVldWVfZGF0YSkKCiAgICBpZiBUb29sTWFuYWdlciBpcyBOb25lOgogICAgICAgIGxvZ19tZXNzYWdlKCJUb29sTWFuYWdlciBpcyBub3QgYXZhaWxhYmxlIGluIHRoaXMgZW52aXJvbm1lbnQ7IGNhbm5vdCBydW4gTG9raS4iKQogICAgICAgIF91cGRhdGVfam9iX3N0YXR1cyhxdWV1ZV9kYXRhLCBqb2JfaWQsICJmYWlsZWQiLCAiVG9vbE1hbmFnZXIgbm90IGF2YWlsYWJsZSIpCiAgICAgICAgX3NhdmVfcXVldWUocXVldWVfcGF0aCwgcXVldWVfZGF0YSkKICAgICAgICByZXR1cm4KCiAgICAjIFJlYWQgZGV2aWNlIGNvbmZpZyB0byBnZXQgc2VydmVyIGFkZHJlc3MgZm9yIFRvb2xNYW5hZ2VyCiAgICB0cnk6CiAgICAgICAgZGV2aWNlVXVpZCwgaG9zdCA9IGdldERldmljZVV1aWQoKQogICAgZXhjZXB0IFN5c3RlbUV4aXQ6CiAgICAgICAgaG9zdCA9ICJhcHAud2Vnd2Vpc2VyLnRlY2giCiAgICAgICAgZGV2aWNlVXVpZCA9IE5vbmUKICAgICAgICBsb2dfbWVzc2FnZSgiRmFpbGVkIHRvIHJlc29sdmUgZGV2aWNlIFVVSUQgZnJvbSBjb25maWc7IGZhbGxpbmcgYmFjayB0byBkZWZhdWx0IGhvc3QuIikKCiAgICB0cnk6CiAgICAgICAgdG0gPSBUb29sTWFuYWdlcihCQVNFX0RJUiwgaG9zdCkKCiAgICAgICAgcGFyYW1ldGVycyA9IGpvYi5nZXQoInBhcmFtZXRlcnMiKSBvciB7fQogICAgICAgIGlmIG5vdCBwYXJhbWV0ZXJzOgogICAgICAgICAgICAjIE1pbmltYWwgc2FmZSBkZWZhdWx0OiBxdWljayB0ZXN0IHNjYW4KICAgICAgICAgICAgcGFyYW1ldGVycyA9IHsidGVzdCI6IFRydWV9CgogICAgICAgIGxvZ19tZXNzYWdlKGYiUnVubmluZyBMb2tpIGpvYiB7am9iX2lkfSB3aXRoIHBhcmFtZXRlcnM6IHtwYXJhbWV0ZXJzfSIpCiAgICAgICAgcmVzdWx0ID0gYXN5bmNpby5ydW4odG0ucnVuX3Rvb2woImxva2kiLCBwYXJhbWV0ZXJzKSkKCiAgICAgICAgc3RhdHVzID0gcmVzdWx0LmdldCgic3RhdHVzIiwgImVycm9yIikKICAgICAgICByZXR1cm5jb2RlID0gcmVzdWx0LmdldCgicmV0dXJuY29kZSIpCiAgICAgICAgc3RkZXJyID0gcmVzdWx0LmdldCgic3RkZXJyIiwgIiIpCgogICAgICAgIGlmIHN0YXR1cyA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgIGxvZ19tZXNzYWdlKGYiTG9raSBqb2Ige2pvYl9pZH0gY29tcGxldGVkIHN1Y2Nlc3NmdWxseSAocmV0dXJuIGNvZGUge3JldHVybmNvZGV9KSIpCiAgICAgICAgICAgIF91cGRhdGVfam9iX3N0YXR1cyhxdWV1ZV9kYXRhLCBqb2JfaWQsICJjb21wbGV0ZWQiKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGVycm9yX21zZyA9IGYiTG9raSBqb2Ige2pvYl9pZH0gZmFpbGVkIHdpdGggcmV0dXJuIGNvZGUge3JldHVybmNvZGV9OiB7c3RkZXJyWy01MDA6XSBpZiBzdGRlcnIgZWxzZSAnJ30iCiAgICAgICAgICAgIGxvZ19tZXNzYWdlKGVycm9yX21zZykKICAgICAgICAgICAgX3VwZGF0ZV9qb2Jfc3RhdHVzKHF1ZXVlX2RhdGEsIGpvYl9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKCiAgICAgICAgX3NhdmVfcXVldWUocXVldWVfcGF0aCwgcXVldWVfZGF0YSkKCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZXJyb3JfbXNnID0gZiJFcnJvciBkdXJpbmcgTG9raSBxdWV1ZSB3b3JrZXIgZXhlY3V0aW9uIGZvciBqb2Ige2pvYl9pZH06IHtzdHIoZSl9IgogICAgICAgIGxvZ19tZXNzYWdlKGVycm9yX21zZykKICAgICAgICBfdXBkYXRlX2pvYl9zdGF0dXMocXVldWVfZGF0YSwgam9iX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgIF9zYXZlX3F1ZXVlKHF1ZXVlX3BhdGgsIHF1ZXVlX2RhdGEpCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgZGVwbG95X2FuZF9ydW5fbG9raSgp"}}